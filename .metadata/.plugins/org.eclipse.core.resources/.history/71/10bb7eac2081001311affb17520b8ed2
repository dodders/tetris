package com.gd.tetris.model;

import java.lang.reflect.Array;

public class Matrix<T> {

	T[][] matrix;
	Class<T> type;
	int rows, cols;
	public enum Rotation { 
		Right, 
		Left; 
	}
	
	@SuppressWarnings("unchecked")
	public Matrix(Class<T> type, int rows, int cols) {
		this.rows = rows;
		this.cols = cols;
		this.type = type;
		this.matrix = (T[][])Array.newInstance(type, rows, cols);
	}
	
	public Matrix(Class<T> type, T[][] m, int rows, int cols) {
		this.matrix = m;
		this.rows = rows;
		this.cols = cols;
		this.type = type;
	}
	
	public boolean addWithoutCollision(Matrix<T> m, int row, int col) {
		boolean ok = true;
		
		@SuppressWarnings("unchecked")
		T[][] save = (T[][])Array.newInstance(this.type, rows, cols);
		array2DCopy(matrix, save); //copy from matrix to save
		for (int r = 0; r < m.rows; r++) {
			for (int c = 0; c < m.cols; c++) {
				if (m.getCell(r, c) != null) {
					if (row + r >= rows || col + c >= cols) {
						ok = false;
						break;
					}
					if (matrix[row + r][col + c] == null) {
						matrix[row + r][col + c] = m.getCell(r, c);
					} else {
						ok = false;
						break;
					}
				}
			}
		}
		if (!ok) {
			array2DCopy(save, matrix); //copy from save to matrix
			return false;
		} else {
			return true;
		}
	}

	private void array2DCopy(T[][] from, T[][] to) {
		for (int i = 0; i < rows; i++) {
			System.arraycopy(from[i], 0, to[i], 0, cols);
		}
	}

	public void add(Matrix<T> m, int row, int col) {
		for (int r = 0; r < m.rows; r++) {
			for (int c = 0; c < m.cols; c++) {
				matrix[row + r][col + c] = m.getCell(r, c);
			}
		}
	}
	
	public String toString() {
		StringBuffer sb = new StringBuffer();
		sb.append("{");
		for (int r = 0; r < rows; r++) {
			sb.append("{");
			for (int c = 0; c < cols; c++) {
				sb.append(matrix[r][c]);
				sb.append(",");
			}
			sb.deleteCharAt(sb.length() - 1);
			sb.append("},");
		}
		sb.deleteCharAt(sb.length() - 1);
		sb.append("}");
		return sb.toString();
	}
	
	public T getCell(int row, int col) {
		return matrix[row][col];
	}
	
	public void setCell(int row, int col, T cell) {
		matrix[row][col] = cell;
	}
	
	public void rotate(Rotation dir) {
		@SuppressWarnings("unchecked")
		T[][] m = (T[][])Array.newInstance(this.type, rows, cols);
		if (dir == Rotation.Right) {
			int tcol = cols - 1;
			for (int r = 0; r < rows; r++) {
				int trow = 0;
				for (int c = 0; c < cols; c++) {
					m[trow][tcol] = matrix[r][c];
					trow++;
				}
				tcol--;
			}
		} else {
			int tcol = 0;
			for (int r = 0; r < rows; r++) {
				int trow = rows - 1;
				for (int c = 0; c < cols; c++) {
					m[trow][tcol] = matrix[r][c];
					trow--;
				}
				tcol++;
			}
		}
		this.matrix = m;
	}
	
	public void log(String msg) {
		System.out.println(msg);
	}
}
